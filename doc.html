<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <title>文档 - Pagon Framework</title>
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/pagon.css">
  <script src="js/highlight.pack.js"></script>
  <link rel="stylesheet" href="css/highlight.css">
  <!--[if lt IE 9]>
  <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <!--[if lt IE 8]>
  <link rel="stylesheet" href="css/ie.css">
  <![endif]-->
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <script type="text/javascript">
    hljs.configure({});
    hljs.initHighlightingOnLoad();
  </script>

</head>
<body>
<div id="wrapper">
  <nav>
    <div id="logo">
    </div>
    <div id="github">
      <a href="https://github.com/hfcorriez/pagon">View on GitHub</a>
    </div>
    <div id="menu">
      <ul>
        <li><a href="./">首页</a></li>
        <li><a href="./guide.html">快速向导</a></li>
        <li><a href="./doc.html" class="highlight">文档</a></li>
        <li><a href="./api.html">API</a></li>
      </ul>
    </div>
    <div id="footer">
      Copyright &copy; Pagon Framework<br />
      Author: <a href="mailto:hfcorriez@gmail.com">@hfcorriez</a>
    </div>
  </nav>
  <article>
    <div class="container">
<h2 id="-">路由</h2>
<p>标准路由</p>
<pre><code class="lang-php">$app-&gt;get(&#39;/auth/:type&#39;, function ($req, $res) {
    // Use key to get param
    $type = $req-&gt;params[&#39;type&#39;];

    // Use index to get param
    $type = $req-&gt;params[0];

    // Todo something...
});
</code></pre>
<p>模糊路由</p>
<pre><code class="lang-php">$app-&gt;get(&#39;/see/*&#39;, function() {
    // Use index to get param
    $what = $req-&gt;params[0];

    // Todo something...
});
</code></pre>
<p>正则路由</p>
<pre><code class="lang-php">$app-&gt;get(&#39;^\/([\d]{4})\/([\d]{2})/([\d]{2})$&#39;, function ($req, $res) {
    $year = $req-&gt;params[0];
    $month = $req-&gt;params[1];
    $day = $req-&gt;params[2];

    // Todo something...
});
</code></pre>
<p>命名路由</p>
<pre><code class="lang-php">$app-&gt;get(&#39;/user/:id&#39;, function ($req, $res) {
    $my_url = Url::route(&#39;user&#39;, array(&#39;id&#39; =&gt; $req-&gt;params[&#39;id&#39;]));

    // Todo something...
})-&gt;name(&#39;user&#39;);
</code></pre>
<p>路由参数默认值</p>
<pre><code class="lang-php">$app-&gt;get(&#39;/abc&#39;, function () {
    // Todo something
})-&gt;defaults(array(&#39;name&#39; =&gt; &#39;abc&#39;));
</code></pre>
<p>路由参数规则</p>
<pre><code class="lang-php">$app-&gt;get(&#39;/archive/:year&#39;, function() {
    // Todo something
})-&gt;rules(array(&#39;year&#39; =&gt; &#39;[\d]{4}&#39;));
</code></pre>
<p>可选参数（只适用标准路由模式）</p>
<p><code>可选参数配合默认值使用会更方便</code></p>
<pre><code class="lang-php">$app-&gt;get(&#39;/auth(/:type)&#39;, function ($req, $res) {
    // Use key to get param
    $type = $req-&gt;params[&#39;type&#39;];
})-&gt;defaults(array(&#39;type&#39; =&gt; &#39;weibo&#39;));
</code></pre>
<h2 id="-">配置</h2>
<p>配置说明</p>
<pre><code>mode        运行模式，一般无需配置，根据PAGON_ENV自动生成
debug       是否开启调试模式
views       模板目录
buffer      是否开启缓冲区
timezone    时区，默认UTC
charset     编码，默认UTF-8,
autoload    自动加载主目录
error       是否Handle PHP抛出的错误
routes      路由列表
names       路由命名，一般自动生成
alias       类的别名，简化很长的类名
namespaces  注册命名空间地址，根据命名空间查找
engines     模板引擎，根据扩展名渲染引擎
errors      默认错误信息
stacks      中间件
mounts      应用加载的路径列表
bundles     包应用
locals      默认的模板变量
safe_query  在模板渲染时自动预防XSS
</code></pre><p>直接传递配置创建应用</p>
<pre><code class="lang-php">$app = new App(array(
    &#39;timezone&#39; =&gt; &#39;Asia/Shanghai&#39;,
    &#39;debug&#39; =&gt;  true,
    &#39;cookie&#39; =&gt; array(
        &#39;secret&#39; =&gt; &#39;very secret&#39;,
        &#39;domain&#39; =&gt; &#39;test.com&#39;,
        &#39;path&#39; =&gt; &#39;/&#39;
    )
));

// 设置配置
$app-&gt;set(&#39;cookie.domain&#39;, &#39;abc.com&#39;);

// 获取配置
$app-&gt;get(&#39;cookie.domain&#39;);
</code></pre>
<p>通过文件加载配置，支持<code>json</code>, <code>yaml</code>, <code>ini</code>, <code>xml</code>和<code>php</code>，例子：</p>
<p>config.php</p>
<pre><code class="lang-php">&lt;?php

return array(
    &#39;timezone&#39; =&gt; &#39;Asia/Shanghai&#39;,
    &#39;debug&#39; =&gt;  true,
    &#39;cookie&#39; =&gt; array(
        &#39;secret&#39; =&gt; &#39;very secret&#39;,
        &#39;domain&#39; =&gt; &#39;app.com&#39;,
        &#39;path&#39; =&gt; &#39;/&#39;
    )
);
</code></pre>
<p>config.json</p>
<pre><code class="lang-json">{
    &quot;timezone&quot;: &quot;Asia/Shanghai&quot;,
    &quot;debug&quot;: true,
    &quot;cookie&quot;: {
        &quot;secret&quot;: &quot;very secret&quot;,
        &quot;domain&quot;: &quot;app.com&quot;,
        &quot;path&quot;: &quot;/&quot;
    }
}
</code></pre>
<p><code>ini</code>和<code>yaml</code>支持在此不再敖述！后续文档会详细的介绍。</p>
<p>注入配置</p>
<pre><code>$app = new App(&#39;config.json&#39;);
</code></pre><h2 id="-">中间件</h2>
<p>中间件是打通<code>输入</code>和<code>输出</code>的中间链路，可以随意发挥来实现一个中间件</p>
<pre><code class="lang-php">$app-&gt;add(function($req, $res, $next) {
    if (!$req-&gt;session(&#39;user_id&#39;)) {
        $res-&gt;status(403)-&gt;end(&#39;Plz login to visit&#39;);
    }
    return $next();
})
</code></pre>
<p>使用框架内置的中间件</p>
<pre><code>- Booster           助推器，根据配置文件为App做一些绑定工作，比如logger和cryptor
- CSRF              CSRF自动防御中间件
- OPAuth            OPAuth的中间件，用来做第三方验证
- PrettyException   异常和错误输出，Debug模式下默认开启
- Flash             信息闪存，用于验证提示等
- HttpMethods       完整的Http方法支持
- HttpBasicAuth     Http Basic验证支持
- I18N              多语言支持
- PageCache         页面缓存支持
- Session           Session支持，包括（Cookie, Redis, Memcache）
- MethodOveride     Http方法重载
</code></pre><p>自带中间件的例子</p>
<pre><code class="lang-php">// 直接生成（适合一些必用的中间件）
$app-&gt;add(new \Pagon\Middleware\Session\Cookie(array(&#39;name&#39; =&gt; &#39;sessions&#39;)));
$app-&gt;add(new \Pagon\Middleware\HttpMethodOverride());

// 或者使用下面这种方式，适合不一定用到或者按路径加载的中间件
$app-&gt;add(&#39;Session\Cookie&#39;, array(&#39;name&#39; =&gt; &#39;sessions&#39;))
$app-&gt;add(&#39;HttpMethodOverride&#39;)

// 按照路由加载中间件
$app-&gt;add(&#39;/monitor&#39;, &#39;HttpBasicAuth&#39;, array(&#39;username&#39; =&gt; &#39;test&#39;, &#39;password&#39; =&gt; &#39;test&#39;));
</code></pre>
<h2 id="-">环境</h2>
<p>环境配置可以通过环境变量<code>PAGON_ENV</code>来设置，默认为<code>develop</code></p>
<pre><code class="lang-php">$app = new App();

// 获取当前环境
$app-&gt;mode();

// 自定义环境模式
$app-&gt;mode(function() {
    return getenv(&quot;PHP_ENV&quot;);
});
</code></pre>
<h2 id="-">控制器</h2>
<p>可以使用Closure的方式实现控制器</p>
<pre><code class="lang-php">$app-&gt;get(&#39;/api/ping&#39;, function($req, $res) {
    $res-&gt;end(&#39;pong&#39;);
});
</code></pre>
<p>也可以通过内置的基础控制器来派生出自己的控制器</p>
<ul>
<li>Restful控制器</li>
</ul>
<pre><code class="lang-php">use Pagon\Rest

class Ping extend Rest {

    // GET /ping
    public function get($req, $res) {
        $res-&gt;end(&#39;pong&#39;);
    }
}


$app-&gt;get(&#39;/ping&#39;, &#39;Ping&#39;);
</code></pre>
<ul>
<li>Classic控制器</li>
</ul>
<pre><code class="lang-php">use Pagon\Classic

class Service extend Classic {

    // GET/POST/... /service/echo
    public function actionEcho($req, $res) {
        $res-&gt;end(&#39;echo&#39;);
    }
}

$app-&gt;all(&#39;/service/:action&#39;, &#39;Service&#39;);
</code></pre>
<h2 id="-">事件</h2>
<p>事件列表</p>
<pre><code>- App
  - run        应用运行前
  - bundle     Bundle加载前
  - bundle.x   x Bundle加载前
  - middleware 中间件加载前
  - flush      输出前
  - end        输出后
  - exit       退出时（错误也会触发）
  - crash      程序异常无法运行
  - error      未捕获错误
</code></pre><p>所有对象都基于事件实现，可以轻松在任何对象上绑定事件</p>
<pre><code class="lang-php">$app-&gt;on(&#39;run&#39;, function(){
    // Start profiler
    xhprof_enabled();
});

$app-&gt;on(&#39;exit&#39;, function(){
    // Get profiler data
    $profiler_data = xhprof_disabled();
    // Save it
});
</code></pre>
<h2 id="-dependency-injector-container-">依赖容器(Dependency Injector Container)</h2>
<p>所有对象都基于依赖容器，都可以实现依赖注入。</p>
<pre><code class="lang-php">// 共享
$app-&gt;share(&#39;db&#39;, function($app){
    extrat($app-&gt;get(&#39;database&#39;));
    return new \PDO($dsn, $username, $password);
})

// 注入
$app-&gt;random = function() {
    return rand();
}
</code></pre>
    </div>
  </article>
</div>
</body>
</html>
